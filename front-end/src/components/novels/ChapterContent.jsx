import { useEffect, useRef, useState } from "react";
import axios from "axios";

const ChapterContent = ({ chapter }) => {
    const [subtitles, setSubtitles] = useState([]);
    const [hoveredSentence, setHoveredSentence] = useState(null);
    const [currentSentenceIndex, setCurrentSentenceIndex] = useState(null);
    const audioRef = useRef(null);

    useEffect(() => {
        if (chapter?.subtitleFileUrl) {
            fetchSubtitles(chapter.subtitleFileUrl);
        }
    }, [chapter]);

    const fetchSubtitles = async (url) => {
        try {
            const response = await axios.get(url);
            const parsedSubtitles = parseSubtitles(response.data);
            setSubtitles(parsedSubtitles);
        } catch (err) {
            console.error("L·ªói khi t·∫£i file ph·ª• ƒë·ªÅ:", err);
        }
    };

    const parseSubtitles = (subtitleContent) => {
        const lines = subtitleContent.trim().split("\n");
        const parsedSubtitles = [];
        let currentSubtitle = {};

        for (const line of lines) {
            if (line.includes("-->")) {
                const [start, end] = line.split(" --> ");
                currentSubtitle.start = timeToSeconds(start);
                currentSubtitle.end = timeToSeconds(end);
            } else if (line.trim() !== "") {
                currentSubtitle.text = line.trim();
                parsedSubtitles.push({ ...currentSubtitle });
                currentSubtitle = {};
            }
        }
        return parsedSubtitles;
    };

    const timeToSeconds = (timeString) => {
        const [hours, minutes, seconds] = timeString.split(":").map(Number.parseFloat);
        return hours * 3600 + minutes * 60 + seconds;
    };

    const handleClick = (text) => {
        const normalizeText = (str) => str.replace(/[.,!?]/g, "").trim().toLowerCase();
        const normalizedInput = normalizeText(text);

        console.log("C√¢u ƒë∆∞·ª£c nh·∫•n:", text);

        const subtitle = subtitles.find((sub) => {
            const normalizedSubtitle = normalizeText(sub.text);
            return normalizedSubtitle === normalizedInput;
        });

        if (subtitle) {
            console.log("Ph·ª• ƒë·ªÅ t√¨m th·∫•y:", subtitle);
            if (audioRef.current) {
                audioRef.current.currentTime = subtitle.start;
                audioRef.current.play();
            }
        } else {
            console.log("Kh√¥ng t√¨m th·∫•y ph·ª• ƒë·ªÅ ph√π h·ª£p.");
        }
    };

    useEffect(() => {
        const audio = audioRef.current;
        if (!audio) return;

        const handleTimeUpdate = () => {
            if (!subtitles.length) return;

            const currentTime = audio.currentTime;
            const activeSubtitle = subtitles.find(
                (sub) => currentTime >= sub.start && currentTime <= sub.end
            );

            if (activeSubtitle) {
                const index = subtitles.findIndex((sub) => sub.text === activeSubtitle.text);
                setCurrentSentenceIndex(index);
                console.log("üîä C√¢u ƒëang ƒë∆∞·ª£c ph√°t:", activeSubtitle.text);
            } else {
                setCurrentSentenceIndex(null);
            }
        };

        audio.addEventListener("timeupdate", handleTimeUpdate);
        return () => audio.removeEventListener("timeupdate", handleTimeUpdate);
    }, [subtitles]);

    return (
        <div className="chapter-detail">
            <h1>{chapter.title}</h1>
            <p><strong>S·ªë ch∆∞∆°ng:</strong> {chapter.chapterNumber}</p>
            <p><strong>ID ch∆∞∆°ng:</strong> {chapter._id}</p>
            <p><strong>ID ti·ªÉu thuy·∫øt:</strong> {chapter.novelId}</p>
            <p><strong>Ng√†y t·∫°o:</strong> {new Date(chapter.createdAt).toLocaleString()}</p>
            <p><strong>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi:</strong> {new Date(chapter.updatedAt).toLocaleString()}</p>

            <h2>N·ªôi dung:</h2>
            <div>
                {chapter.content?.split(". ").map((sentence, index) => (
                    <span 
                        key={index} 
                        onMouseEnter={() => setHoveredSentence(index)}
                        onMouseLeave={() => setHoveredSentence(null)}
                        onClick={() => handleClick(sentence.trim())} 
                        style={{ 
                            cursor: "pointer",
                            backgroundColor: currentSentenceIndex === index 
                                ? "rgba(255, 255, 0, 0.5)" 
                                : hoveredSentence === index 
                                    ? "rgba(255, 255, 255, 0.2)"
                                    : "transparent",
                            padding: "2px",
                            borderRadius: "4px",
                            transition: "background-color 0.2s ease-in-out"
                        }}
                    >
                        {sentence}.
                    </span>
                ))}
            </div>

            <h2>Audio:</h2>
            {chapter.audioFileUrl ? (
                <audio ref={audioRef} controls src={chapter.audioFileUrl}>
                    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t audio.
                </audio>
            ) : (
                <p>Kh√¥ng c√≥ file audio.</p>
            )}
        </div>
    );
};

export default ChapterContent;
